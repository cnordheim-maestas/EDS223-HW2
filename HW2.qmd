---
title: "Homework Assignment 2: Exploring patterns of environmental justice"
author: "Caitlin Nordheim-Maestas"
date: "`r Sys.Date()`"
format: html
---

Instructions here: <https://eds-223-geospatial.github.io/assignments/HW2.html>

HINT: LOOK UP CRS IN METADATA!

# Setup

```{r}
#| message: false
#| warning: false

library(tidyverse)
library(sf)
library(tmap)
library(here)
library(viridisLite) # colors
library(janitor)
library(kableExtra) # pretty table

# load in data 
#ejscreen
ej <- st_read(here::here("data", "ejscreen", "EJSCREEN_2023_BG_StatePct_with_AS_CNMI_GU_VI.gdb"))
# check valid
unique(st_is_valid(ej)) # yay

# holc
holc <- st_read(here::here("data", "mapping-inequality", "mapping-inequality-los-angeles.json")) %>% 
  st_make_valid()

# check and make valid
unique(st_is_valid(holc)) # yay!


# bird
bird <- st_read(here::here("data", "gbif-birds-LA", "gbif-birds-LA.shp"))
# check and make valid
unique(st_is_valid(bird)) # yay!
```


# Part 1

## Part 1.1

Create a map of historical redlining neighborhoods

```{r}
#| message: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

m1.1 <- tm_shape(holc) + # import holc geo data
  tm_basemap("Esri.WorldGrayCanvas") + # dull background that still has geo info
  tm_graticules() + # to get our bearings
  # fill by HOLC "grade" assigned
  tm_fill(fill = "grade", # each hold grade a different color
          fill.scale = tm_scale(values =  # assigning colors manually to match the historical figures
                                  c("green", "blue", "yellow", "pink", "black")),
          # this matches historical redlining maps in the metadata
          fill.legend = tm_legend(title = "HOLC Grade")) +
   tm_borders(col = "black", lwd = 0.5) + # makes it look more refined with borders
  tm_title("HOLC Grade Designations in Los Angeles") + # add title
# add map elements
  tm_compass(show.labels = 1, position = c("right","top")) + # compas
  tm_scalebar(position = c("right", "bottom")) + # scalebar
  tm_credits("Data Source: Digital Scholarship Lab", position = c("right", "bottom")) # data credits

m1.1
```

## Part 1.2

Create a table summarizing:

- the percentage of census block groups that fall within each HOLC grade

- Also include the percent of census black groups that don’t fall within a HOLC grade

- Hint: The HOLC data contains the grades and the EJScreen data contains the census blocks, so you will need to combine the data spatially before doing summary statistics. Once you combine and no longer need the geometries, you can use st_drop_geometry().

```{r}
#| message: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

# filter ej data to just LA county
ej.la <- ej %>%
  filter(CNTY_NAME == "Los Angeles County")

# crs check!!
# st_crs(ej.la) == st_crs(holc) # false
ej.la <- st_transform(ej.la, crs= st_crs(holc)) # set to same as holc
# st_crs(ej.la) == st_crs(holc) # true, yay!

# JOIN 
# join x,y adds y columns to x
ej_holc <- st_join(ej.la, holc) %>%
  clean_names() %>% # bc the caps are driving me crazy
  st_drop_geometry() # no longer needed

### summary stats
# the percentage of "census block groups" that fall within each HOLC grade
# percent of census block groups that don’t fall within a HOLC grade
# total rows #nrow(ej_holc) # 8988
ej_holc %>% 
  group_by(grade) %>% 
  # number in this group/ total rows *100 %
  #rounded to 2 decimal places
 summarise(
    Percent = round((n() / 8988) * 100, 2)) %>% 
  mutate(Percent = paste0(Percent, "%")) %>% 
  rename(HOLC_Grade = grade) %>%   # capitalize for pretty table
  st_drop_geometry() %>% 
  # pretty table
  kbl(booktabs = T, caption = "Census block groups and percent") %>%
  kable_styling(latex_options = "striped")
```

## Part 1.3

Create at least two visualizations summarizing current conditions (from the EJScreen data) within HOLC grades using the mean of the following variables (you may combine variables or create separate plots):

% low income
percentile for Particulate Matter 2.5
percentile for low life expectancy
Use ggplot for your visualizations! You will first need to calculate mean of each variable grouped by HOLC grade.

```{r}
#| message: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

## Wrangle means
means <- ej_holc %>% 
  group_by(grade) %>% # for each grade calculate:
  summarize(low_income_mean = mean(lowincpct, na.rm = TRUE),
            pm25_mean = mean(d2_pm25, na.rm = TRUE),
            life_exp_pct_mean = mean(lifeexppct, na.rm = TRUE)) %>% 
            # make more intuitive (actual percents not proportions)
            mutate(pct_low_income = low_income_mean * 100) %>% 
             mutate(pct_le = life_exp_pct_mean * 100)

### Low Income plot
means %>%  
  ggplot(aes(x = grade, y = pct_low_income, fill = grade)) + # color by grade for fun
  geom_col() + # bar chart
  labs(
    x = "HOLC Grade", # grade on x
    y = "Percent Low Income Within Grade (%)", # percent 
    title = "Mean low income by HOLC grade") + # add title
  theme_minimal() + # clean theme
  theme(legend.position = "none") # legend does not add anything just fun colors

### PM
means %>%  
  ggplot(aes(x = grade, y = pm25_mean, fill = grade)) + # color by grade for fun
  geom_col() + # bar chart
  labs(
    x = "HOLC Grade", # grade on x
    y = "Percentile of PM 2.5 Pollution",
    title = "Particulate Matter Pollution by HOLC grade") + # add title
  theme_minimal() + # clean theme
  theme(legend.position = "none") # legend does not add anything just fun colors

### life expectancy
means %>%  
  ggplot(aes(x = grade, y = pct_le, fill = grade)) + # color by grade for fun
  geom_col() + # bar chart
  labs(
    x = "HOLC Grade", # grade on x
    y = "Percent Low Life Expectancy Within Grade (%)",
    title = "Low Life Expectancy by HOLC grade") + # add title
  theme_minimal() + # clean theme
  theme(legend.position = "none") # legend does not add anything just fun colors
```

## Part 1.4 (COME BACK TO THIS)

- Write a brief paragraph reflecting on these results

- Interpret the patterns you observe in your results

- Discuss potential relationships between historical redlining grades and current environmental/socioeconomic conditions







